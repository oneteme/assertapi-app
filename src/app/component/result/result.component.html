<div class="content">
    <div class="header-page">
        <div class="title">
            <div class="icon">
                <mat-icon class="material-icons-outlined">desktop_windows</mat-icon>
            </div>
            <div class="label">
                <div class="title">Supervision des tests</div>
                <div class="sub-title">Lancement des tests</div>
            </div>
        </div>
    </div>
    <mat-accordion class="example-headers-align" style="margin-bottom: 1em;">
        <mat-expansion-panel #launchPanel [expanded]="step === 1">
            <mat-expansion-panel-header #launchPanelHeader>
                <mat-panel-title>
                    Lancement
                </mat-panel-title>
                <mat-panel-description>
                    Choisissez vos environnements
                    <mat-icon>launch</mat-icon>
                </mat-panel-description>
            </mat-expansion-panel-header>
            <div style="display: flex; align-content: space-around;">
                <div style="display: flex; flex-direction: column; flex-grow: 1;" [formGroup]="actualForm">
                    <div style="margin-bottom: 1em; display: flex;">
                        <mat-form-field style="width: 50%;" appearance="fill">
                            <mat-label>Application actuelle</mat-label>
                            <mat-select formControlName="app">
                                <mat-option *ngFor="let app of actualApps" [value]="app.value">{{app.name}}</mat-option>
                            </mat-select>
                            <mat-error *ngIf="actualApp.hasError('required')">L'application est obligatoire
                            </mat-error>
                        </mat-form-field>
                        <mat-form-field style="width: 50%;" appearance="fill">
                            <mat-label>Environnement actuel</mat-label>
                            <mat-select formControlName="env">
                                <mat-option *ngFor="let env of actualEnvs" [value]="env.value">{{env.name}}</mat-option>
                            </mat-select>
                            <mat-error *ngIf="actualEnv.hasError('required')">L'environnement est obligatoire
                            </mat-error>
                        </mat-form-field>
                    </div>
                    <div style="display: flex; flex-direction: column;" [formGroup]="actualLogin">
                        <div style="display: flex;">
                            <mat-form-field style="width: 50%;" appearance="fill">
                                <mat-label>Nom d'utilisateur</mat-label>
                                <input matInput formControlName="username">
                                <mat-error *ngIf="actualLoginUsername.hasError('required')">Le nom d'utilisateur est
                                    obligatoire</mat-error>
                            </mat-form-field>
                            <mat-form-field style="width: 50%;" appearance="fill">
                                <mat-label>Mot de passe</mat-label>
                                <input matInput [type]="hide ? 'password' : 'text'" formControlName="password">
                                <button mat-icon-button matSuffix (click)="hide = !hide">
                                    <mat-icon>{{hide ? 'visibility_off' : 'visibility'}}</mat-icon>
                                </button>
                                <mat-error *ngIf="actualLoginpassword.hasError('required')">Le mot de passe est
                                    obligatoire</mat-error>
                            </mat-form-field>
                        </div>
                    </div>
                </div>
                <mat-divider [vertical]="true"></mat-divider>
                <div style="display: flex; flex-direction: column; flex-grow: 1;" [formGroup]="expectedForm">
                    <div style="margin-bottom: 1em; display: flex;">
                        <mat-form-field style="width: 50%;" appearance="fill">
                            <mat-label>Application attendue</mat-label>
                            <mat-select formControlName="app">
                                <mat-option *ngFor="let app of expectedApps" [value]="app.value">{{app.name}}
                                </mat-option>
                            </mat-select>
                            <mat-error *ngIf="expectedApp.hasError('required')">L'environnement est obligatoire
                            </mat-error>
                        </mat-form-field>
                        <mat-form-field style="width: 50%;" appearance="fill">
                            <mat-label>Environnement attendu</mat-label>
                            <mat-select formControlName="env">
                                <mat-option *ngFor="let env of expectedEnvs" [value]="env.value">{{env.name}}
                                </mat-option>
                            </mat-select>
                            <mat-error *ngIf="expectedEnv.hasError('required')">L'environnement est obligatoire
                            </mat-error>
                        </mat-form-field>
                    </div>
                    <div style="display: flex; flex-direction: column;" [formGroup]="expectedLogin">
                        <div style="display: flex;">
                            <mat-form-field style="width: 50%;" appearance="fill">
                                <mat-label>Nom d'utilisateur</mat-label>
                                <input matInput formControlName="username">
                                <mat-error *ngIf="expectedLoginUsername.hasError('required')">Le nom d'utilisateur est
                                    obligatoire</mat-error>
                            </mat-form-field>
                            <mat-form-field style="width: 50%;" appearance="fill">
                                <mat-label>Mot de passe</mat-label>
                                <input matInput [type]="hide ? 'password' : 'text'" formControlName="password">
                                <button mat-icon-button matSuffix (click)="hide = !hide">
                                    <mat-icon>{{hide ? 'visibility_off' : 'visibility'}}</mat-icon>
                                </button>
                                <mat-error *ngIf="expectedLoginpassword.hasError('required')">Le mot de passe est
                                    obligatoire</mat-error>
                            </mat-form-field>
                        </div>
                    </div>
                </div>
            </div>
            <mat-action-row>
                <button mat-button color="primary" (click)="choose()">
                    <div style="display: flex; align-items: center;">
                        <mat-icon class="material-icons-outlined" style="margin-right: 0.5em;">filter_alt</mat-icon>
                        Liste des tests
                    </div>
                </button>
            </mat-action-row>
        </mat-expansion-panel>

    </mat-accordion>
    <mat-accordion class="example-headers-align" style="margin-bottom: 1em;">
        <mat-expansion-panel #choosePanel [disabled]="step == 1">
            <mat-expansion-panel-header #choosePanelHeader>
                <mat-panel-title>
                    Requêtes
                </mat-panel-title>
                <mat-panel-description>
                    Choisissez vos tests à désactiver
                    <mat-icon>checklist_rtl</mat-icon>
                </mat-panel-description>
            </mat-expansion-panel-header>

            <mat-form-field style="width: 100%;">
                <input matInput (keyup)="applyFilter($event)" placeholder="Filtrer..." #input>
            </mat-form-field>
            <mat-paginator #choosePaginator [pageSizeOptions]="[10, 20, 50]"></mat-paginator>

            <table mat-table [dataSource]="chooseDataSource" #chooseSort="matSort" matSort>
                <ng-container matColumnDef="name">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Nom de l'Api </th>
                    <td mat-cell *matCellDef="let element">
                        {{element.request.name}}
                        <div style="display: flex; align-items: center;">
                            <mat-icon class="material-icons-outlined" style="margin-right: 0.2em;">description
                            </mat-icon>
                            {{element.request.description}}
                        </div>
                    </td>
                </ng-container>

                <ng-container matColumnDef="select">
                    <th mat-header-cell *matHeaderCellDef>
                        <mat-checkbox style="margin-bottom: 0.5em;" (change)="$event ? toggleChooseAllRows() : null"
                            [checked]="chooseSelection.hasValue() && isChooseAllSelected()"
                            [indeterminate]="chooseSelection.hasValue() && !isChooseAllSelected()">
                        </mat-checkbox>
                    </th>
                    <td mat-cell *matCellDef="let row">
                        <mat-checkbox (click)="$event.stopPropagation()"
                            (change)="$event ? chooseSelection.toggle(row) : null"
                            [checked]="chooseSelection.isSelected(row)">
                        </mat-checkbox>
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="chooseDisplayedColumns;  sticky: true"></tr>
                <tr mat-row *matRowDef="let row; columns: chooseDisplayedColumns;"></tr>
                <tr class="mat-row" *matNoDataRow>
                    <td class="mat-cell" colspan="4">Aucune donnée correspondant au filtre</td>
                </tr>
            </table>
            <mat-action-row>
                <button mat-button color="primary" (click)="launch()">
                    <div style="display: flex; align-items: center;">
                        Lancer les tests
                        <mat-icon class="material-icons-outlined" style="margin-left: 0.5em;">playlist_play</mat-icon>
                    </div>
                </button>
            </mat-action-row>
        </mat-expansion-panel>
    </mat-accordion>

    <div style="display: flex; justify-content: space-between; margin-bottom: 1em; gap: 1em" *ngIf="step == 3">
        <mat-card style="width: 30%">
            <mat-card-content
                style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%;">
                <h1>{{nbTests}}</h1>
                Nombre de tests lancés
            </mat-card-content>
        </mat-card>
        <mat-card style="width: 70%; display: flex; justify-content: space-between;">
            <app-chart style="width: 60%;"></app-chart>
            <div
                style="width: 40%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                <div style="display: flex; align-items: center; color: green" *ngIf="nbTestsOK > 0">
                    <mat-icon style="margin-right: 0.5em;">done</mat-icon>
                    {{nbTestsOK}} / {{nbTests}}
                </div>
                <div style="display: flex; align-items: center; color: black" *ngIf="nbTestsSkip > 0">
                    <mat-icon style="margin-right: 0.5em;">block</mat-icon>
                    {{nbTestsSkip}} / {{nbTests}}
                </div>
                <div style="display: flex; align-items: center; color: gold" *ngIf="nbTestsKO > 0">
                    <mat-icon style="margin-right: 0.5em;">report</mat-icon>
                    {{nbTestsKO}} / {{nbTests}}
                </div>
                <div style="display: flex; align-items: center; color: red" *ngIf="nbTestsFail > 0">
                    <mat-icon style="margin-right: 0.5em;">report</mat-icon>
                    {{nbTestsFail}} / {{nbTests}}
                </div>
            </div>
        </mat-card>
    </div>
    <div style="padding-bottom: 1em;" *ngIf="step == 3">
        <div style="display: flex;" [formGroup]="filterForm">
            <mat-form-field style="width: 100%;">
                <input matInput formControlName="filter" placeholder="Filtrer..." #input>
                <button (click)="onResetFilter()" *ngIf="filterForm?.controls['filter']?.value" matSuffix
                    mat-icon-button>
                    <mat-icon>close</mat-icon>
                </button>
            </mat-form-field>
            <mat-form-field style="width: 30%;">
                <mat-label>Statut</mat-label>
                <mat-select multiple formControlName="status">
                    <mat-option *ngFor="let s of status | keyvalue" [value]="s.key">{{s.key}}</mat-option>
                </mat-select>
            </mat-form-field>
        </div>
        <div class="mat-elevation-z8">
            <mat-paginator #resultPaginator [pageSizeOptions]="[5, 10, 20, 50]"></mat-paginator>
            <mat-table [dataSource]="resultDataSource" #resultSort="matSort" matSort>
                <ng-container matColumnDef="status">
                    <mat-header-cell *matHeaderCellDef></mat-header-cell>
                    <mat-cell *matCellDef="let element">
                        <mat-spinner *ngIf="!element.result" color="primary" mode="indeterminate" diameter="20">
                        </mat-spinner>
                        <mat-icon *ngIf="element.result" [ngStyle]="{color:status[element.result.status]['color']}">
                            {{status[element.result.status]['icon']}}</mat-icon>
                    </mat-cell>
                </ng-container>
                <ng-container matColumnDef="name">
                    <mat-header-cell *matHeaderCellDef mat-sort-header> Nom de l'Api </mat-header-cell>
                    <mat-cell *matCellDef="let element" style="display: flex; flex-direction: column; align-items: flex-start;">
                        {{element.request.name}}
                        <div style="display: flex; align-items: center;">
                            <mat-icon class="material-icons-outlined" style="margin-right: 0.2em;">description
                            </mat-icon>
                            {{element.request.description}}
                        </div>
                    </mat-cell>
                </ng-container>

                <ng-container matColumnDef="select">
                    <mat-header-cell *matHeaderCellDef>
                        <mat-checkbox style="margin-bottom: 0.5em;" *ngIf="filterNotOK()?.length"
                            (change)="$event ? toggleResultAllRows() : null"
                            [checked]="resultSelection.hasValue() && isResultAllSelected()"
                            [indeterminate]="resultSelection.hasValue() && !isResultAllSelected()">
                        </mat-checkbox>
                    </mat-header-cell>
                    <mat-cell *matCellDef="let row">
                        <mat-checkbox *ngIf="row.result && row.result.status != 'OK'" (click)="$event.stopPropagation()"
                            (change)="$event ? resultSelection.toggle(row) : null"
                            [checked]="resultSelection.isSelected(row)">
                        </mat-checkbox>
                    </mat-cell>
                </ng-container>

                <ng-container matColumnDef="actions">
                    <mat-footer-cell *matFooterCellDef colspan="4">
                        <div style="width: 100%; display: flex; flex-direction: column; align-items: end;">
                            <button mat-button color="primary" [disabled]="!resultSelection.hasValue()"
                                (click)="launch()">
                                <div style="display: flex; align-items: center;">
                                    Relancer les tests
                                    <mat-icon class="material-icons-outlined" style="margin-left: 0.5em;">replay
                                    </mat-icon>
                                </div>
                            </button>
                        </div>
                    </mat-footer-cell>
                </ng-container>

                <mat-header-row *matHeaderRowDef="resultDisplayedColumns;  sticky: true"></mat-header-row>
                <mat-row style="cursor: pointer;" matRipple *matRowDef="let row; columns: resultDisplayedColumns;"
                    (click)="compare(row)"></mat-row>
                <tr class="mat-row" style="display: flex;" *matNoDataRow>
                    <td class="mat-cell" style="flex: 1; display: flex; align-items: center;" colspan="4">Aucune donnée
                        correspondant au filtre</td>
                </tr>
                <mat-footer-row *matFooterRowDef="['actions']"></mat-footer-row>
            </mat-table>
        </div>

    </div>

    <!-- <mat-action-row>
                <button mat-button color="primary" (click)="launch()">
                    <div style="display: flex; align-items: center;">
                        Relancer
                        <mat-icon class="material-icons-outlined" style="margin-left: 0.5em;">playlist_play</mat-icon>
                    </div>
                </button>
            </mat-action-row> -->



    <!-- <mat-list>
            <mat-list-item style="height: 50px;" *ngFor="let assertionResult of assertionResults">
                <mat-spinner mat-list-icon style="padding: 0; margin-left: 4px;" *ngIf="!assertionResult.result"
                    color="primary" mode="indeterminate" diameter="20">
                </mat-spinner>
                <mat-icon mat-list-icon *ngIf="assertionResult.result"
                    [ngStyle]="{color:status[assertionResult.result.status]['color']}">
                    {{status[assertionResult.result.status]['icon']}}</mat-icon>
                <div mat-line>{{assertionResult.request.name}}</div>
                <div mat-line>{{assertionResult.request.description}}</div>
                <mat-checkbox style="margin-left: 1em;" (click)="$event.stopPropagation()"
                    (change)="$event ? resultSelection.toggle(assertionResult) : null"
                    [checked]="resultSelection.isSelected(assertionResult)">
                </mat-checkbox>
                <button mat-icon-button style="margin-left: 1em;" matTooltip="Voir la difference des reponses" matTooltipPosition="left" (click)="compare(assertionResult)">
                    <mat-icon color="primary">
                        difference
                    </mat-icon>
                </button>
            </mat-list-item>
        </mat-list> -->

</div>